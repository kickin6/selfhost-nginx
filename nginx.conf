events { }

http {
#    upstream lmstudio {
#        server selfhost-image:5001;
#    }

#    upstream selfhost-image {
#        server selfhost-image:5002;
#    }

    upstream selfhost-video {
        server selfhost-video:5003;
    }

#    upstream selfhost-tts {
#        server selfhost-tts:5004;
#    }

    # Listen on port 80 and 443 for general traffic
    server {
        listen 80;
        listen 443 ssl;
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;

        # Serve static files from /movies
        location /movies/ {
            alias /app/movies/;
            autoindex on;
            try_files $uri $uri/ =404;
        }

        # Proxy requests to lmstudio-api on port 5001
#        location /lmstudio {
#            proxy_pass http://lmstudio;
#            proxy_set_header Host $host;
#            proxy_set_header X-Real-IP $remote_addr;
#            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#            proxy_set_header X-Forwarded-Proto $scheme;
#        }

        # Proxy requests to selfhost-image on port 5002
#        location /selfhost-image {
#            proxy_pass http://selfhost-image;
#            proxy_set_header Host $host;
#            proxy_set_header X-Real-IP $remote_addr;
#            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#            proxy_set_header X-Forwarded-Proto $scheme;
#        }

        # Proxy requests to selfhost-video on port 5003
        location /python-selfhost-video {
            proxy_pass http://selfhost-video;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

#        # Proxy requests to selfhost-tts on port 5004
#        location /selfhost-tts {
#            proxy_pass http://selfhost-tts;
#            proxy_set_header Host $host;
#            proxy_set_header X-Real-IP $remote_addr;
#            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#            proxy_set_header X-Forwarded-Proto $scheme;
#        }
#
#        # Proxy requests to python-webhook on port 5005
#        location /python-webhook {
#            proxy_pass http://webhook;
#            proxy_set_header Host $host;
#            proxy_set_header X-Real-IP $remote_addr;
#            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#            proxy_set_header X-Forwarded-Proto $scheme;
#        }

        # Redirect root requests to selfhost-image as an example
        location / {
            return 301 /python-selfhost-video;
        }
    }

    # Listen on additional ports for selfhost-image
#    server {
#        listen 8443 ssl;
#        ssl_certificate /etc/nginx/ssl/cert.pem;
#        ssl_certificate_key /etc/nginx/ssl/key.pem;
#
#        location / {
#            proxy_pass http://lmstudio;
#            proxy_set_header Host $host;
#            proxy_set_header X-Real-IP $remote_addr;
#            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#            proxy_set_header X-Forwarded-Proto $scheme;
#        }
#    }

#    server {
#        listen 9443 ssl;
#        ssl_certificate /etc/nginx/ssl/cert.pem;
#        ssl_certificate_key /etc/nginx/ssl/key.pem;
#
#        location / {
#            proxy_pass http://selfhost-image;
#            proxy_set_header Host $host;
#            proxy_set_header X-Real-IP $remote_addr;
#            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#            proxy_set_header X-Forwarded-Proto $scheme;
#        }
#    }

    # Listen on additional ports for selfhost-video
    server {
        listen 10443 ssl;
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;

        location / {
            proxy_pass http://selfhost-video;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        # Serve static files from /movies
        location /movies/ {
            alias /app/movies/;
            autoindex on;
            try_files $uri $uri/ =404;
        }
    }

#    # Listen on additional ports for selfhost-tts
#    server {
#        listen 11443 ssl;
#        ssl_certificate /etc/nginx/ssl/cert.pem;
#        ssl_certificate_key /etc/nginx/ssl/key.pem;
#
#        location / {
#            proxy_pass http://selfhost-tts;
#            proxy_set_header Host $host;
#            proxy_set_header X-Real-IP $remote_addr;
#            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#            proxy_set_header X-Forwarded-Proto $scheme;
#        }
#    }
}
